#!/bin/bash
set -eu
set -o pipefail

REPO_ROOT="$(git rev-parse --show-toplevel)"
pushd "$REPO_ROOT" >/dev/null
if [[ -f .env.local ]]; then
  set -a
  # shellcheck disable=SC1091
  source .env.local
  set +a
fi

if [[ -z ${PROJECTS:-} ]]; then
  # shellcheck disable=SC2016
  echo '$PROJECTS is not set'
  exit 1
fi

read -r -a project_list <<<"$PROJECTS"

for project in "${project_list[@]}"; do
  if [[ ! -f "compose.${project}.yaml" ]]; then
    echo "compose.${project}.yaml not found"
    exit 1
  fi
  echo "Deploying ${project}"
  make "${project}-down"
done

git pull

for project in "${project_list[@]}"; do
  if [[ ! -f "compose.${project}.yaml" ]]; then
    echo "compose.${project}.yaml not found"
    exit 1
  fi
  echo "Deploying ${project}"
  make "${project}-deploy"
done

make docker-prune

popd >/dev/null
