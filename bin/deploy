#!/bin/bash
set -eu
set -o pipefail

REPO_ROOT="$(git rev-parse --show-toplevel)"
pushd "$REPO_ROOT" >/dev/null
if [[ -f .env.local ]]; then
  set -a
  # shellcheck disable=SC1091
  source .env.local
  set +a
fi

if [[ -z ${PROJECTS:-} ]]; then
  # shellcheck disable=SC2016
  echo '$PROJECTS is not set'
  exit 1
fi

read -r -a project_list <<<"$PROJECTS"

for project in "${project_list[@]}"; do
  echo "Deploying ${project}"
  make --no-print-directory "${project}-deploy"
done

make --no-print-directory docker-prune

popd >/dev/null
